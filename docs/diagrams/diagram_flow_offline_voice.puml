@startuml 离线语音功能流程
!theme plain
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60
skinparam responseMessageBelowArrow true

actor 用户
participant "应用层" as App
participant "音频处理器" as Audio
participant "唤醒词检测" as WakeWord
participant "本地ASR" as LocalASR
participant "本地命令识别器" as CmdRecognizer
participant "本地TTS引擎" as LocalTTS
participant "语音合成器" as Speaker

autonumber

用户 -> Audio: 发出声音
Audio -> WakeWord: 音频数据流
WakeWord -> App: 检测到唤醒词
App -> App: 更新状态(kDeviceStateListening)
App -> Audio: 开始录制对话
Audio -> App: 原始音频数据流
App -> LocalASR: 传入音频数据
LocalASR -> LocalASR: 离线语音识别
LocalASR --> App: 返回识别文本
App -> CmdRecognizer: 文本分析
CmdRecognizer -> CmdRecognizer: 意图识别/命令匹配
CmdRecognizer --> App: 返回识别结果
alt 识别到已知命令
    App -> App: 执行对应本地操作
    App -> LocalTTS: 生成响应文本
    LocalTTS -> LocalTTS: 离线合成语音
    LocalTTS -> Speaker: 语音数据流
    Speaker -> 用户: 播放合成语音
else 未识别命令/超出能力范围
    App -> App: 更新状态(提示联网)
    App -> LocalTTS: 生成提示文本
    LocalTTS -> Speaker: 语音数据流
    Speaker -> 用户: 播放"请连接网络"提示
end
App -> App: 重置状态(kDeviceStateIdle)

@enduml 